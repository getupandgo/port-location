version: '2'

vars:
  BIN_DIR: '{{ default "bin" .BUILD_BIN_DIR }}'
  VERSION: 0.1

tasks:
  build:
    desc: "build binaries in {{ .BIN_DIR }}"
    cmds:
      - mkdir -p "{{ .BIN_DIR }}"
      - go build -o "{{ .BIN_DIR }}/" ./cmd/...

  generate:
    desc: "runs go generate"
    status:
      - sh -c '[ ! -z $SKIP_GENERATE ]'
    cmds:
      - go generate -x ./...

  lint:
    desc: "Run linters"
    cmds:
      - golangci-lint run --deadline=10m  --color always ./...
      - prototool lint ./api/proto
      - prototool format -l ./api/proto

  test_integration:
    desc: "Run integration tests"
    cmds:
      - docker rm -f test-postgres
      - docker run --name test-postgres -e POSTGRES_PASSWORD=example -p 5435:5432 -d postgres
      - CGO_ENABLED=1 go test -race -p=1 -count=1 ./internal/...
      - docker rm -f test-postgres

  gen_grpc:
    desc: "Generate go files for gRPC"
    cmds:
      - prototool format -w
      - prototool generate .

  build_portdomain:
    cmds:
      - docker build -f build/package/portdomain/Dockerfile -t getupandgo/portdomain:{{.VERSION}} .

  build_clientapi:
    cmds:
      - docker build -f build/package/clientapi/Dockerfile -t getupandgo/clientapi:{{.VERSION}} .